<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Control CMS</title>
    
    <!-- 1. Carga la librería Decap CMS (Versión 3.x) -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- 2. Carga el Widget de Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0d1117;
        color: #c9d1d9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      #loader {
        font-size: 1.2rem;
        text-align: center;
      }
    </style>
</head>
<body>
    <div id="loader">Cargando Panel de Administración...</div>

    <script>
      const SITE_URL = 'https://chic-marzipan-8a5cf6.netlify.app';

      if (typeof netlifyIdentity !== 'undefined') {
          // Inicialización explícita de Netlify Identity
          netlifyIdentity.init({ APIUrl: `${SITE_URL}/.netlify/identity` });

          // Listener al iniciar Identity
          netlifyIdentity.on('init', user => {
              if (user) {
                  document.getElementById('loader').textContent = 'Usuario detectado. Cargando Decap CMS...';
                  // Inicializa CMS
                  if (typeof window.CMS !== 'undefined') {
                      window.CMS.init();
                  }
              } else if (window.location.hash) {
                  netlifyIdentity.open();
              }
          });

          // Listener al iniciar sesión
          netlifyIdentity.on('login', user => {
              if (user) {
                  document.getElementById('loader').textContent = 'Inicio de sesión exitoso. Cargando CMS...';
                  if (window.location.hash) window.location.hash = '';
                  if (typeof window.CMS !== 'undefined') {
                      window.CMS.init();
                  }
              }
          });

          // Opcional: Listener al cerrar sesión
          netlifyIdentity.on('logout', () => {
              document.getElementById('loader').textContent = 'Sesión cerrada. Recargando página...';
              window.location.reload();
          });

      } else {
          document.getElementById('loader').textContent = 'Error: netlify-identity-widget.js no se ha cargado.';
      }
    </script>
</body>
</html>
