<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Editor Visual — Pro</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          appleBg: '#0b1220',
          card: '#0f1724',
          accent: '#0ee7c0',
          accentSoft: '#9ff3e0'
        },
        fontFamily: {
          sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial']
        }
      }
    }
  }
</script>

<!-- Icons (heroicons mini) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@heroicons/vue@2.0.16/dist/mini.css" />

<style>
  html,body { height:100%; }
  body { background: linear-gradient(180deg,#071025 0%, #0b1220 100%); -webkit-font-smoothing:antialiased; }
  .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.04); }
  .apple-btn { box-shadow: 0 6px 18px rgba(2,6,23,0.6); }
  .iframe-frame { border-radius: 12px; overflow: hidden; border:1px solid rgba(255,255,255,0.04); }
  .toolbar-btn:focus { outline: 2px solid rgba(14,231,192,0.18); }
  /* simple scrollbar for gallery */
  .thin-scroll::-webkit-scrollbar { width: 8px; height:8px; }
  .thin-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 8px; }
  .thin-scroll::-webkit-scrollbar-track { background: transparent; }
  /* floating toolbar */
  #wysiwygToolbar { transition: opacity .18s, transform .18s; }
</style>
</head>
<body class="text-slate-100 font-sans">

<!-- Top bar -->
<header class="flex items-center justify-between px-6 py-4 border-b border-white/6 glass">
  <div class="flex items-center gap-4">
    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-white/5 to-white/2 flex items-center justify-center apple-btn">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="text-accent"><path d="M12 2L20 7v10l-8 5-8-5V7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div>
      <div class="text-accent font-semibold text-lg">Editor Visual y de Código</div>
      <div class="text-white/60 text-xs">WYSIWYG, arrastrar y previsualización móvil — estilo Apple</div>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <button id="themeToggle" class="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/6 text-sm">Modo claro</button>
    <button id="openPreviewWindow" class="px-3 py-2 rounded-lg bg-accent text-slate-900 font-semibold">Abrir vista (nueva pestaña)</button>
  </div>
</header>

<!-- Layout -->
<div class="flex gap-6 px-6 py-6 h-[calc(100vh-96px)]">

  <!-- Sidebar -->
  <aside class="w-80 glass rounded-2xl p-4 flex flex-col gap-4 apple-btn">
    <!-- choose dir -->
    <div>
      <label class="text-xs text-white/70">1 • Carpeta raíz del proyecto</label>
      <div class="mt-2 flex gap-2">
        <button id="selectDirBtn" class="flex-1 py-2 rounded-lg bg-accent text-slate-900 font-semibold hover:opacity-95">Seleccionar carpeta</button>
        <button id="refreshBtn" class="w-10 h-10 rounded-lg bg-white/3 flex items-center justify-center" title="Refrescar">⟳</button>
      </div>
      <p id="currentDir" class="text-xs text-white/60 mt-2 truncate">Ninguna carpeta seleccionada</p>
    </div>

    <!-- pages -->
    <div class="flex-1">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-semibold text-white/90">Páginas</h3>
        <span id="pagesCount" class="text-xs text-white/60">0</span>
      </div>
      <ul id="pagesList" class="space-y-2 thin-scroll max-h-56 overflow-y-auto"></ul>

      <!-- new file -->
      <div class="mt-4">
        <label class="text-xs text-white/60">Crear nueva</label>
        <div class="flex gap-2 mt-2">
          <input id="newPageName" class="flex-1 rounded-lg px-3 py-2 bg-white/3 placeholder:text-white/60" placeholder="nombre-pagina (sin .html)" />
          <button id="createPageBtn" class="px-3 py-2 rounded-lg bg-green-500 font-semibold hover:opacity-95">Crear</button>
        </div>
      </div>
    </div>

    <!-- images -->
    <div>
      <label class="text-xs text-white/60">Subir / Galería</label>
      <div class="mt-2 flex gap-2">
        <label class="flex-1 px-3 py-2 rounded-lg bg-white/4 cursor-pointer text-sm text-white/90">Seleccionar foto
          <input id="imageUpload" type="file" accept="image/*" class="hidden" />
        </label>
        <button id="uploadImageBtn" class="w-10 h-10 rounded-lg bg-indigo-600">⇪</button>
      </div>
      <p id="uploadedFileName" class="text-xs text-white/60 mt-2 truncate">Ninguna seleccionada</p>

      <div class="mt-3">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-sm font-semibold">Galería</h4>
          <small class="text-xs text-white/60">Arrastra a la vista</small>
        </div>
        <div id="imageGallery" class="grid grid-cols-2 gap-2 max-h-36 overflow-y-auto rounded-lg p-2 bg-white/2 thin-scroll"></div>
      </div>
    </div>

    <!-- settings -->
    <div class="pt-2 border-t border-white/4">
      <div class="flex items-center justify-between text-xs text-white/70">
        <span>Vista móvil embebida</span>
        <label class="inline-flex items-center cursor-pointer">
          <input id="mobilePreviewToggle" type="checkbox" class="hidden">
          <span id="mobileToggleVisual" class="w-10 h-5 bg-white/6 rounded-full relative before:absolute before:w-4 before:h-4 before:rounded-full before:bg-white/90 before:left-0.5 before:top-0.5 transition-all"></span>
        </label>
      </div>
    </div>
  </aside>

  <!-- Main editor area -->
  <main class="flex-1 flex flex-col gap-4">
    <!-- WYSIWYG toolbar (floating) -->
    <div id="wysiwygToolbar" class="glass rounded-lg p-2 flex gap-2 items-center shadow-sm" style="align-self:flex-start">
      <button class="toolbar-btn px-2 py-1 rounded hover:bg-white/5" data-cmd="bold"><b>B</b></button>
      <button class="toolbar-btn px-2 py-1 rounded hover:bg-white/5" data-cmd="italic"><i>I</i></button>
      <button class="toolbar-btn px-2 py-1 rounded hover:bg-white/5" data-cmd="underline"><u>U</u></button>
      <button class="toolbar-btn px-2 py-1 rounded hover:bg-white/5" data-cmd="insertUnorderedList">• List</button>
      <button class="toolbar-btn px-2 py-1 rounded hover:bg-white/5" data-cmd="formatBlock" data-value="h1">H1</button>
      <button id="insertLinkBtn" class="toolbar-btn px-2 py-1 rounded hover:bg-white/5">Link</button>
      <button id="insertImageBtn" class="toolbar-btn px-2 py-1 rounded hover:bg-white/5">Imagen</button>
      <div class="ml-4 text-xs text-white/60">Modo: <span id="editorModeLabel">Visual</span></div>
    </div>

    <!-- editor + code -->
    <div class="flex gap-4 h-full">
      <!-- visual / iframe -->
      <section class="flex-1 glass rounded-2xl p-4 iframe-frame relative">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-medium text-white/90">Vista editable</div>
          <div class="flex items-center gap-2">
            <button id="syncToCodeBtn" class="px-3 py-1 rounded bg-white/5 text-sm">Actualizar código</button>
            <button id="clearSelectionBtn" class="px-3 py-1 rounded bg-white/5 text-sm">Limpiar selección</button>
          </div>
        </div>

        <div id="editorWrapper" class="h-[70vh] border border-white/4 rounded-lg overflow-hidden">
          <iframe id="previewIframe" title="Editor preview" class="w-full h-full bg-white" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>

        <!-- embedded mobile preview -->
        <div id="mobilePreview" class="mt-3 hidden glass rounded-lg p-2">
          <div class="flex items-center gap-3 mb-2">
            <div class="text-sm font-semibold">Preview Móvil</div>
            <div class="text-xs text-white/60">Simula pantalla</div>
            <div class="ml-auto flex gap-1">
              <button data-width="360" class="px-2 py-1 rounded bg-white/5 text-xs">360px</button>
              <button data-width="375" class="px-2 py-1 rounded bg-white/5 text-xs">375px</button>
              <button data-width="414" class="px-2 py-1 rounded bg-white/5 text-xs">414px</button>
            </div>
          </div>
          <div id="mobileIframeWrapper" class="w-[360px] border border-white/4 rounded overflow-hidden">
            <iframe id="mobileIframe" class="w-full" style="height:700px"></iframe>
          </div>
        </div>
      </section>

      <!-- code panel -->
      <aside class="w-[470px] flex flex-col glass rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-medium text-white/90">Código HTML</div>
          <div class="flex gap-2">
            <button id="saveBtn" class="px-3 py-1 rounded bg-accent text-slate-900 font-semibold">Guardar</button>
            <button id="openInNew" class="px-3 py-1 rounded bg-white/5">Abrir</button>
          </div>
        </div>

        <textarea id="codeEditor" class="flex-1 resize-none bg-transparent text-white/90 p-3 rounded outline-none font-mono text-sm"></textarea>
        <div class="flex items-center justify-between mt-3">
          <div id="statusMessage" class="text-xs text-white/60">Sin cambios</div>
          <div class="text-xs text-white/60">Última acción: —</div>
        </div>
      </aside>
    </div>
  </main>
</div>

<script>
/* ========= Variables y elementos ========= */
const $ = id => document.getElementById(id);
const elements = {
  selectDirBtn: $('selectDirBtn'),
  refreshBtn: $('refreshBtn'),
  currentDir: $('currentDir'),
  pagesList: $('pagesList'),
  pagesCount: $('pagesCount'),
  newPageName: $('newPageName'),
  createPageBtn: $('createPageBtn'),
  imageUpload: $('imageUpload'),
  uploadImageBtn: $('uploadImageBtn'),
  uploadedFileName: $('uploadedFileName'),
  imageGallery: $('imageGallery'),
  previewIframe: $('previewIframe'),
  mobileIframe: $('mobileIframe'),
  mobilePreview: $('mobilePreview'),
  mobilePreviewToggle: $('mobilePreviewToggle'),
  mobileToggleVisual: $('mobileToggleVisual'),
  mobilePreviewWrapper: $('mobileIframeWrapper'),
  codeEditor: $('codeEditor'),
  saveBtn: $('saveBtn'),
  openInNew: $('openInNew'),
  saveBtnMain: $('saveBtn'),
  createPageBtnEl: $('createPageBtn'),
  selectDirBtnEl: $('selectDirBtn'),
  statusMessage: $('statusMessage'),
  wysiwygToolbar: $('wysiwygToolbar'),
  editorWrapper: $('editorWrapper'),
  themeToggle: $('themeToggle'),
  openPreviewWindow: $('openPreviewWindow'),
  insertImageBtn: $('insertImageBtn'),
  insertLinkBtn: $('insertLinkBtn'),
  syncToCodeBtn: $('syncToCodeBtn'),
  clearSelectionBtn: $('clearSelectionBtn'),
  pagesCountLabel: $('pagesCount')
};

let baseDirHandle = null;
let assetsImagesHandle = null;
let currentFileHandle = null;
let currentFileName = null;
let urlMap = new Map(); // if we create temporary URLs
let observer = null;

/* ========= UI helpers ========= */
function setStatus(text, type='info'){
  elements.statusMessage.textContent = text;
  if(type==='success') elements.statusMessage.className='text-sm text-emerald-300';
  else if(type==='error') elements.statusMessage.className='text-sm text-rose-300';
  else elements.statusMessage.className='text-sm text-white/60';
}

/* ========= Theme toggle (dark/light) ========= */
let isLight = false;
elements.themeToggle.addEventListener('click', ()=>{
  isLight = !isLight;
  if(isLight){
    document.documentElement.style.background='linear-gradient(180deg,#f7f9fb,#eef6fb)';
    document.body.style.color='#0b1220';
    elements.themeToggle.textContent='Modo oscuro';
  } else {
    document.documentElement.style.background='';
    document.body.style.color='';
    elements.themeToggle.textContent='Modo claro';
  }
});

/* ========= Directory / Filesystem: select folder, ensure assets/images ========= */
elements.selectDirBtn.addEventListener('click', async ()=>{
  if(!window.showDirectoryPicker){ setStatus('Tu navegador no soporta File System Access', 'error'); return; }
  try {
    baseDirHandle = await window.showDirectoryPicker({ mode:'readwrite' });
    elements.currentDir.textContent = baseDirHandle.name;
    // ensure assets/images
    const assetsHandle = await baseDirHandle.getDirectoryHandle('assets', { create:true });
    assetsImagesHandle = await assetsHandle.getDirectoryHandle('images', { create:true });
    await loadPagesList();
    await loadImageGallery();
    setStatus(`Carpeta abierta: ${baseDirHandle.name}`, 'success');
  } catch (e) {
    if(e.name !== 'AbortError') setStatus('Error abriendo carpeta: '+e.message, 'error');
  }
});

elements.refreshBtn.addEventListener('click', async ()=>{
  if(baseDirHandle){
    await loadPagesList();
    await loadImageGallery();
    setStatus('Refrescado', 'info');
  }
});

/* ========= Pages list ========= */
async function loadPagesList(){
  elements.pagesList.innerHTML = '';
  if(!baseDirHandle) return;
  const files = [];
  for await (const [name, handle] of baseDirHandle.entries()){
    if(name.endsWith('.html')) files.push({name, handle});
  }
  files.sort((a,b)=>a.name.localeCompare(b.name));
  files.forEach(f=>{
    const li = document.createElement('li');
    li.className = 'p-2 rounded hover:bg-white/3 cursor-pointer';
    li.textContent = f.name;
    li.addEventListener('click', ()=> loadPageForEditing(f.name, f.handle));
    elements.pagesList.appendChild(li);
  });
  elements.pagesCount.textContent = files.length;
}

/* ========= Load page into iframe (editable) ========= */
async function loadPageForEditing(filename, handle){
  try {
    currentFileHandle = handle;
    currentFileName = filename;
    const file = await handle.getFile();
    const content = await file.text();

    // Reset urlMap (temporary URLs)
    urlMap.forEach(u => URL.revokeObjectURL(u)); urlMap.clear();

    const iframeDoc = elements.previewIframe.contentDocument;
    iframeDoc.open();
    iframeDoc.write(content);
    iframeDoc.close();

    // Make editable
    iframeDoc.designMode = 'on';
    iframeDoc.body.setAttribute('contentEditable', 'true');

    // Rewrite any relative image paths to temporary object URLs for reliable preview + set data-src
    await rewriteImagesToPreview(iframeDoc);

    // Observe changes
    if(observer) observer.disconnect();
    observer = new MutationObserver(() => updateCodeEditor());
    observer.observe(iframeDoc.body, { childList:true, subtree:true, characterData:true });

    updateCodeEditor();
    setStatus(`Editando: ${filename}`, 'success');

  } catch (e) {
    setStatus('Error cargando archivo: '+e.message, 'error');
  }
}

/* ========= Image handling: find all images recursively in assets and build gallery ========= */
async function getAllImages(dirHandle, prefix=''){
  const result = [];
  for await (const [name, handle] of dirHandle.entries()){
    if(handle.kind === 'file' && name.match(/\.(png|jpe?g|gif|webp|svg)$/i)){
      result.push({ name, path: prefix + name, handle });
    } else if(handle.kind === 'directory'){
      const sub = await getAllImages(handle, prefix + name + '/');
      result.push(...sub);
    }
  }
  return result;
}

async function loadImageGallery(){
  elements.imageGallery.innerHTML = '';
  if(!assetsImagesHandle) return;
  try {
    const images = await getAllImages(assetsImagesHandle);
    if(images.length === 0){
      elements.imageGallery.innerHTML = '<div class="text-white/50 text-xs">No hay imágenes en assets/images</div>';
      return;
    }
    for(const img of images){
      const file = await img.handle.getFile();
      const objectUrl = URL.createObjectURL(file);
      // create gallery img element (draggable)
      const imgEl = document.createElement('img');
      imgEl.src = objectUrl;
      imgEl.dataset.path = 'assets/images/' + img.path;
      imgEl.draggable = true;
      imgEl.className = 'w-full h-20 object-cover rounded cursor-grab border border-white/6';
      // dragstart sets the path
      imgEl.addEventListener('dragstart', (ev)=>{
        ev.dataTransfer.setData('text/plain', imgEl.dataset.path);
      });
      // click inserts
      imgEl.addEventListener('click', ()=> insertImageAtCursor(imgEl.dataset.path));
      elements.imageGallery.appendChild(imgEl);
      // store object URLs to revoke later when needed
      urlMap.set(imgEl.dataset.path, objectUrl);
    }
  } catch (e) {
    console.error(e);
    elements.imageGallery.innerHTML = '<div class="text-rose-300 text-xs">Error cargando galería</div>';
  }
}

/* ========= Insert image into iframe WITHOUT saving blob: create temp preview but store data-src path ========= */
async function insertImageAtCursor(relativePath){
  try {
    const iframeDoc = elements.previewIframe.contentDocument;
    // find the file handle inside assetsImagesHandle by walking path parts
    const pathParts = relativePath.replace(/^assets\/images\//, '').split('/');
    let handle = assetsImagesHandle;
    for(const part of pathParts){ handle = await handle.getFileHandle(part); }
    const file = await handle.getFile();
    const tempUrl = URL.createObjectURL(file);
    // create image element
    const img = iframeDoc.createElement('img');
    img.src = tempUrl;            // preview using object URL
    img.dataset.src = relativePath; // real path to store on save
    img.style.maxWidth = '100%';
    img.style.display = 'block';
    img.style.margin = '8px auto';
    // insert at cursor
    const sel = iframeDoc.getSelection();
    if(!sel || sel.rangeCount === 0) {
      iframeDoc.body.appendChild(img);
    } else {
      const range = sel.getRangeAt(0);
      range.insertNode(img);
      range.setStartAfter(img);
      range.setEndAfter(img);
      sel.removeAllRanges();
      sel.addRange(range);
    }
    updateCodeEditor();
    setStatus('Imagen insertada: ' + relativePath, 'success');
  } catch (e) {
    console.error(e);
    setStatus('Error insertando imagen: ' + e.message, 'error');
  }
}

/* When loading an HTML into iframe, convert relative image src -> object URL and set data-src */
async function rewriteImagesToPreview(iframeDoc){
  const imgs = iframeDoc.querySelectorAll('img');
  for(const img of imgs){
    const src = img.getAttribute('src') || '';
    // skip http(s)
    if(src.startsWith('http') || src.startsWith('data:')) continue;
    // try to find the file in assets (assume path relative like assets/images/...)
    try {
      let relative = src;
      // If src starts with '/', remove leading slash for matching
      if(relative.startsWith('/')) relative = relative.slice(1);
      // try to get file handle by path pieces starting at baseDirHandle
      // We expect paths like assets/images/...
      const parts = relative.split('/').filter(Boolean);
      let handle = baseDirHandle;
      for(let i=0;i<parts.length;i++){
        if(i === parts.length -1){
          // final => file
          handle = await handle.getFileHandle(parts[i]);
        } else {
          handle = await handle.getDirectoryHandle(parts[i]);
        }
      }
      const file = await handle.getFile();
      const temp = URL.createObjectURL(file);
      img.dataset.src = relative; // store original relative path
      img.src = temp;
      urlMap.set(relative, temp);
    } catch (e) {
      // couldn't find file; leave as-is (will be a broken image)
      console.warn('no se encontró imagen para', src);
    }
  }
}

/* ========= Drag & drop from gallery into iframe ========= */
(function enableDropOnIframe(){
  const iframe = elements.previewIframe;
  iframe.addEventListener('load', ()=>{
    const doc = iframe.contentDocument;
    // prevent default navigation when dropping
    doc.addEventListener('dragover', ev => ev.preventDefault());
    doc.addEventListener('drop', ev => {
      ev.preventDefault();
      const path = ev.dataTransfer.getData('text/plain');
      if(path) insertImageAtCursor(path);
    });
    // also allow paste images / files (optional)
    doc.addEventListener('paste', (ev)=>{
      // optional: handle pasted images
    });
  });
})();

/* ========= WYSIWYG toolbar actions (execCommand on iframe document) ========= */
document.querySelectorAll('#wysiwygToolbar .toolbar-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const cmd = btn.dataset.cmd;
    const val = btn.dataset.value || null;
    const iframeDoc = elements.previewIframe.contentDocument;
    iframeDoc.execCommand(cmd, false, val);
    updateCodeEditor();
  });
});

elements.insertLinkBtn.addEventListener('click', ()=>{
  const url = prompt('Introduce URL (https://...)');
  if(!url) return;
  const iframeDoc = elements.previewIframe.contentDocument;
  iframeDoc.execCommand('createLink', false, url);
  updateCodeEditor();
});

elements.insertImageBtn.addEventListener('click', async ()=>{
  // allow user to pick from gallery path or paste url
  const path = prompt('Introduce ruta relativa de imagen (ej. assets/images/foto.jpg) o deja vacío para seleccionar desde galería:');
  if(path) insertImageAtCursor(path);
  else {
    // focus gallery
    setStatus('Haz click en una miniatura de la galería para insertar', 'info');
  }
});

/* ========= Sync iframe -> code and code -> iframe helpers ========= */
function updateCodeEditor(){
  const iframeDoc = elements.previewIframe.contentDocument;
  if(!iframeDoc) return;
  // clone body and swap object URLs for data-src for saving (we'll do cleaning on save)
  const clone = iframeDoc.documentElement.cloneNode(true);

  // For images that have data-src, replace their src in the clone with the stored relative path
  clone.querySelectorAll('img').forEach(img=>{
    if(img.dataset && img.dataset.src) {
      img.setAttribute('src', img.dataset.src);
    }
  });

  const html = '<!DOCTYPE html>\n' + clone.outerHTML;
  elements.codeEditor.value = html;
  setStatus('Código actualizado', 'info');
}

/* also allow user to sync from code to iframe (overwrite iframe) */
elements.syncToCodeBtn.addEventListener('click', ()=>{
  const html = elements.codeEditor.value;
  const iframeDoc = elements.previewIframe.contentDocument;
  iframeDoc.open(); iframeDoc.write(html); iframeDoc.close();
  // rewrite images again
  rewriteImagesToPreview(iframeDoc);
  setStatus('Iframe actualizado desde el código', 'success');
});

/* ========= Save: replace blob/object URLs with data-src (relative) before writing ========= */
elements.saveBtn.addEventListener('click', async ()=>{
  if(!currentFileHandle){ setStatus('No hay archivo abierto para guardar', 'error'); return; }
  try {
    // Take the code editor's value (which should already contain relative src if updateCodeEditor ran)
    let contentToSave = elements.codeEditor.value;

    // As additional safety: replace any src="blob:..." with corresponding data-src if available in iframe
    // We'll parse the iframe DOM and map object URLs -> data-src
    const iframeDoc = elements.previewIframe.contentDocument;
    const map = new Map();
    iframeDoc.querySelectorAll('img').forEach(img=>{
      const obj = img.src || '';
      const rel = img.dataset && img.dataset.src ? img.dataset.src : null;
      if(obj && rel){
        map.set(obj, rel);
      }
    });
    // Replace occurrences in contentToSave
    map.forEach((rel, objUrl)=>{
      // escape regex
      const esc = objUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      contentToSave = contentToSave.replace(new RegExp(esc, 'g'), rel);
    });

    // Also remove any data-src attributes (not needed in saved HTML)
    contentToSave = contentToSave.replace(/\sdata-src="[^"]*"/g, '');

    // Finally write
    const writable = await currentFileHandle.createWritable();
    await writable.write(contentToSave);
    await writable.close();

    setStatus('Guardado correcto ✅', 'success');
  } catch (e) {
    console.error(e);
    setStatus('Error guardando: '+e.message, 'error');
  }
});

/* ========= Create / Delete pages ========= */
elements.createPageBtn.addEventListener('click', async ()=>{
  if(!baseDirHandle){ setStatus('Selecciona la carpeta primero', 'error'); return; }
  let name = elements.newPageName.value.trim();
  if(!name) return setStatus('Nombre inválido', 'error');
  if(!name.endsWith('.html')) name += '.html';
  try {
    const fh = await baseDirHandle.getFileHandle(name, { create:true });
    const w = await fh.createWritable();
    const starter = `<!doctype html><html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" /><title>${name}</title></head><body><h1>Hola</h1><p>Página nueva.</p></body></html>`;
    await w.write(starter); await w.close();
    elements.newPageName.value = '';
    await loadPagesList();
    loadPageForEditing(name, fh);
    setStatus('Página creada', 'success');
  } catch (e) { setStatus('Error creando: '+e.message, 'error'); }
});

elements.openInNew.addEventListener('click', async ()=>{
  // open current code into a new tab as data URL
  const html = elements.codeEditor.value || '<!DOCTYPE html><html><body></body></html>';
  const w = window.open();
  w.document.open(); w.document.write(html); w.document.close();
});

/* ========= Upload image to assets/images ========= */
elements.uploadImageBtn.addEventListener('click', async ()=>{
  const files = elements.imageUpload.files;
  if(!files || files.length === 0) return setStatus('Selecciona una imagen', 'error');
  if(!assetsImagesHandle) return setStatus('assets/images no disponible', 'error');
  try {
    const file = files[0];
    const fh = await assetsImagesHandle.getFileHandle(file.name, { create:true });
    const writable = await fh.createWritable();
    await writable.write(file);
    await writable.close();
    elements.imageUpload.value = '';
    elements.uploadedFileName.textContent = 'Ninguna seleccionada';
    await loadImageGallery();
    setStatus('Imagen subida: '+file.name, 'success');
  } catch (e) {
    setStatus('Error subiendo imagen: '+e.message, 'error');
  }
});

elements.imageUpload.addEventListener('change', ()=>{
  const f = elements.imageUpload.files[0];
  if(f){ elements.uploadedFileName.textContent = f.name; elements.uploadImageBtn.disabled = false; }
  else { elements.uploadedFileName.textContent = 'Ninguna seleccionada'; elements.uploadImageBtn.disabled = true; }
});

/* ========= Mobile preview toggle and sizing ========= */
$('mobilePreviewToggle').addEventListener('change', (e)=>{
  const checked = e.target.checked;
  elements.mobilePreview.style.display = checked ? 'block' : 'none';
  // set initial iframe content to match editor
  const html = elements.codeEditor.value;
  elements.mobileIframe.srcdoc = html;
});

document.querySelectorAll('#mobilePreview button[data-width]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const w = btn.dataset.width;
    elements.mobileIframe.style.width = w + 'px';
  });
});

/* ========= Open preview window (new tab) ========= */
elements.openPreviewWindow.addEventListener('click', ()=>{
  const html = elements.codeEditor.value || '<!DOCTYPE html><html><body></body></html>';
  const w = window.open('', '_blank');
  w.document.open(); w.document.write(html); w.document.close();
});

/* ========= Utilities on load ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // initial states
  elements.uploadImageBtn.disabled = true;
  setStatus('Listo — abre una carpeta para empezar', 'info');
  // enable drop from OS to gallery (optional)
  elements.imageGallery.addEventListener('dragover', ev => ev.preventDefault());
});

/* ========= Clean up object URLs on unload ========= */
window.addEventListener('beforeunload', ()=>{
  urlMap.forEach(u => URL.revokeObjectURL(u));
});

/* ========= Keyboard shortcuts ========= */
window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
    e.preventDefault();
    elements.saveBtn.click();
  }
});
</script>
</body>
</html>
